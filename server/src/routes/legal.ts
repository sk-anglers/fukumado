import { Router, Request, Response } from 'express';

export const legalRouter = Router();

/**
 * 利用規約の内容
 */
const TERMS_OF_SERVICE = {
  version: '1.0.0',
  effectiveDate: '2025-11-01',
  lastUpdated: '2025-11-01',
  content: `
# 利用規約

最終更新日: 2025年11月1日

本利用規約（以下「本規約」といいます）は、ふくまど！（以下「本サービス」といいます）の利用条件を定めるものです。本サービスをご利用いただくにあたり、本規約の全文をお読みいただき、同意いただく必要があります。

## 第1条（本サービスの概要）

1. 本サービスは、YouTube、Twitch等の動画配信プラットフォームが提供する公式Embed API及びIframe APIを使用した、複数配信の同時視聴を補助するツールです。
2. 本サービスは、各プラットフォームの配信コンテンツそのものを提供、保存、複製、再配信するものではなく、ユーザーの視聴体験を向上させるための補助機能を提供します。
3. 配信コンテンツの著作権、商標権その他一切の知的財産権は、各配信者及びプラットフォーム事業者に帰属し、本サービス運営者は一切の権利を主張しません。

## 第2条（利用登録）

1. 本サービスの基本機能は、利用登録なしでご利用いただけます。
2. 一部の機能（YouTubeやTwitchアカウントとの連携等）をご利用いただく場合、各プラットフォームのアカウント認証が必要となります。
3. 認証情報は本サービスのサーバーに永続的に保存されることはなく、セッション中のみ使用されます。

## 第3条（禁止事項）

ユーザーは、本サービスの利用にあたり、以下の行為を行ってはなりません。

1. 法令または公序良俗に違反する行為
2. 犯罪行為に関連する行為
3. 本サービスの運営を妨害する行為
4. 他のユーザーまたは第三者の権利（著作権、商標権、プライバシー権等）を侵害する行為
5. 配信者への嫌がらせ、誹謗中傷、スパム行為
6. 本サービスのシステムへの不正アクセス、リバースエンジニアリング
7. 本サービスのAPIを利用した自動化ツールの作成（当社の許可なく）
8. YouTube、Twitch等のプラットフォーム利用規約に違反する行為
9. 本サービスを商用目的で利用する行為（当社の許可なく）
10. その他、本サービス運営者が不適切と判断する行為

## 第4条（本サービスの提供の停止等）

1. 本サービス運営者は、以下のいずれかの事由があると判断した場合、ユーザーに事前に通知することなく本サービスの全部または一部の提供を停止または中断することができるものとします。
   - 本サービスにかかるコンピュータシステムの保守点検または更新を行う場合
   - 地震、落雷、火災、停電または天災などの不可抗力により、本サービスの提供が困難となった場合
   - コンピュータまたは通信回線等が事故により停止した場合
   - YouTube Data API、Twitch API等の外部サービスの仕様変更、利用制限、停止があった場合
   - その他、本サービス運営者が本サービスの提供が困難と判断した場合
2. 本サービス運営者は、本サービスの提供の停止または中断により、ユーザーまたは第三者が被ったいかなる不利益または損害についても、一切の責任を負わないものとします。

## 第5条（利用制限および登録抹消）

本サービス運営者は、ユーザーが以下のいずれかに該当する場合には、事前の通知なく、ユーザーに対して、本サービスの全部もしくは一部の利用を制限し、またはユーザーとしての登録を抹消することができるものとします。

1. 本規約のいずれかの条項に違反した場合
2. 登録事項に虚偽の事実があることが判明した場合
3. その他、本サービス運営者が本サービスの利用を適当でないと判断した場合

## 第6条（免責事項）

1. 本サービス運営者は、本サービスに事実上または法律上の瑕疵（安全性、信頼性、正確性、完全性、有効性、特定の目的への適合性、セキュリティなどに関する欠陥、エラーやバグ、権利侵害などを含みます。）がないことを保証するものではありません。
2. 本サービスは、YouTube、Twitch等の外部サービスのAPIを利用しているため、それらのサービスの仕様変更、利用制限、停止により、予告なく機能が制限または停止される可能性があります。
3. 本サービスに起因してユーザーに生じたあらゆる損害について、本サービス運営者の故意または重過失による場合を除き、本サービス運営者は一切の責任を負いません。
4. 本サービスから外部サイト（YouTube、Twitch等）へのリンクまたは外部サイトから本サービスへのリンクが提供されている場合でも、本サービス運営者は、外部サイトについて一切の責任を負いません。
5. 本サービスを通じて表示される配信コンテンツの内容については、各配信者が責任を負うものとし、本サービス運営者は一切の責任を負いません。

## 第7条（サービス内容の変更等）

本サービス運営者は、ユーザーへの事前の告知をもって、本サービスの内容を変更、追加または廃止することがあり、ユーザーはこれを承諾するものとします。

## 第8条（利用規約の変更）

1. 本サービス運営者は、必要と判断した場合には、ユーザーに通知することなくいつでも本規約を変更することができるものとします。
2. 変更後の本規約は、本サービス上に掲示された時点で効力を生じるものとします。
3. 本規約の変更後、本サービスの利用を開始した場合には、当該ユーザーは変更後の規約に同意したものとみなします。

## 第9条（個人情報の取扱い）

本サービス運営者は、本サービスの利用によって取得する個人情報については、本サービス運営者が別途定める「プライバシーポリシー」に従い適切に取り扱うものとします。

## 第10条（知的財産権）

1. 本サービス上に表示される文章、画像、プログラム、ソースコード、デザイン等（配信コンテンツを除く）に関する知的財産権は、本サービス運営者または正当な権利を有する第三者に帰属します。
2. ユーザーは、本サービス運営者の事前の許可なく、これらを複製、転載、公衆送信、改変等してはなりません。

## 第11条（外部サービスとの関係）

1. 本サービスは、以下の外部サービスのAPIまたはSDKを利用しています。
   - YouTube Data API v3（Google LLC）
   - Twitch API（Twitch Interactive, Inc.）
   - その他の動画配信プラットフォーム
2. ユーザーは、これらの外部サービスを利用するにあたり、各サービスの利用規約を遵守する責任を負います。
3. 外部サービスの利用規約違反により生じた問題については、ユーザー自身が責任を負うものとし、本サービス運営者は一切の責任を負いません。

## 第12条（有料サービス）

1. 本サービスの一部機能は、有料プランとして提供される場合があります。
2. 有料プランの詳細（料金、支払方法、解約方法等）については、別途「特定商取引法に基づく表記」に記載します。
3. 一度お支払いいただいた料金は、本サービス運営者の責に帰すべき事由がある場合を除き、返金いたしません。

## 第13条（準拠法・裁判管轄）

1. 本規約の解釈にあたっては、日本法を準拠法とします。
2. 本サービスに関して紛争が生じた場合には、本サービス運営者の所在地を管轄する裁判所を専属的合意管轄とします。

## お問い合わせ

本規約に関するお問い合わせは、以下の連絡先までお願いいたします。

- サービス名: ふくまど！
- 運営者: ふくまど！公式運営チーム
- 連絡先: fukumado_admin@fukumado.jp
- お問い合わせフォーム: https://forms.gle/8epH3BGw8xDTGe1W6

以上
  `.trim()
};

/**
 * プライバシーポリシーの内容
 */
const PRIVACY_POLICY = {
  version: '1.0.0',
  effectiveDate: '2025-11-01',
  lastUpdated: '2025-11-01',
  content: `
# プライバシーポリシー

最終更新日: 2025年11月1日

ふくまど！（以下「本サービス」といいます）は、ユーザーのプライバシーを尊重し、個人情報の保護に努めます。本プライバシーポリシー（以下「本ポリシー」といいます）は、本サービスがどのような情報を収集し、どのように利用・管理するかを説明するものです。

## 第1条（個人情報の定義）

本ポリシーにおいて「個人情報」とは、個人情報の保護に関する法律（個人情報保護法）に定める「個人情報」を指し、生存する個人に関する情報であって、当該情報に含まれる氏名、メールアドレス、その他の記述等により特定の個人を識別できる情報を指します。

## 第2条（収集する情報）

本サービスは、ユーザーから以下の情報を収集する場合があります。

### 2-1. ユーザーが提供する情報

1. OAuth認証情報
   - Google（YouTube）アカウント認証時: ユーザーID、メールアドレス、プロフィール情報
   - Twitchアカウント認証時: ユーザーID、表示名、プロフィール情報
   - 注意: アクセストークンはサーバーに永続的に保存されず、セッション中のみ使用されます。

2. 有料プラン加入時の情報（将来的に提供される可能性があります）
   - 氏名、メールアドレス
   - 決済情報（クレジットカード情報は決済代行業者が管理し、本サービスは保持しません）

### 2-2. 自動的に収集される情報

1. ブラウザ情報
   - IPアドレス
   - ブラウザの種類・バージョン
   - OS情報
   - アクセス日時

2. 利用状況情報
   - 視聴したチャンネル情報（ブラウザのlocalStorageに保存）
   - レイアウト設定
   - 音量・ミュート設定
   - フォローチャンネルリスト

3. Cookie情報
   - セッション管理のためのCookie
   - サービス改善のための分析Cookie（将来的に導入される可能性があります）

## 第3条（情報の利用目的）

本サービスは、収集した情報を以下の目的で利用します。

1. 本サービスの提供・運営のため
2. ユーザーの本人確認のため
3. YouTube、Twitch等の外部サービスとの連携のため
4. ユーザーからのお問い合わせに対応するため
5. 本サービスの改善、新機能の開発のため
6. 利用規約違反行為への対応のため
7. 有料プランの決済処理のため（将来的に導入される場合）
8. メンテナンス、重要なお知らせなどの配信のため

## 第4条（情報の保存場所）

### 4-1. クライアント側（ブラウザ）

以下の情報は、ユーザーのブラウザのlocalStorageに保存されます。

- フォローチャンネルリスト
- レイアウト設定
- 音量・ミュート設定
- スロット割り当て情報

これらの情報は、ブラウザのキャッシュをクリアすることでいつでも削除できます。

### 4-2. サーバー側

本サービスは、以下の情報をサーバー側に保存します。

- セッション情報（一時的、有効期限: 7日間）
- アクセスログ（IPアドレス、アクセス日時等、保存期間: 最大90日間）

重要: OAuth認証で取得したアクセストークンは、サーバーに永続的に保存されることはありません。

## 第5条（情報の第三者提供）

本サービスは、以下の場合を除き、ユーザーの個人情報を第三者に提供することはありません。

1. ユーザーの同意がある場合
2. 法令に基づく場合
3. 人の生命、身体または財産の保護のために必要がある場合であって、本人の同意を得ることが困難である場合
4. 国の機関もしくは地方公共団体またはその委託を受けた者が法令の定める事務を遂行することに対して協力する必要がある場合

## 第6条（外部サービスとの情報共有）

本サービスは、以下の外部サービスと必要最小限の情報を共有します。

### 6-1. YouTube（Google LLC）

- 提供情報: OAuth認証で取得したアクセストークン（一時的）
- 利用目的: ユーザーの購読チャンネル取得、ライブ配信情報の取得
- プライバシーポリシー: https://policies.google.com/privacy

### 6-2. Twitch（Twitch Interactive, Inc.）

- 提供情報: OAuth認証で取得したアクセストークン（一時的）
- 利用目的: ユーザーのフォローチャンネル取得、ライブ配信情報の取得
- プライバシーポリシー: https://www.twitch.tv/p/legal/privacy-notice/

### 6-3. 決済代行サービス（将来的に導入される可能性があります）

有料プラン提供時には、Stripe、PayPal等の決済代行サービスを利用する場合があります。クレジットカード情報等の決済情報は、本サービスではなく、決済代行サービスが管理します。

## 第7条（Cookieの利用）

本サービスは、以下の目的でCookieを利用します。

1. 必須Cookie: ログイン状態の維持、セッション管理
2. 分析Cookie（将来的に導入される可能性があります）: サービス利用状況の分析、改善

ユーザーは、ブラウザの設定によりCookieを無効化できますが、その場合、本サービスの一部機能が利用できなくなる可能性があります。

## 第8条（セキュリティ）

本サービスは、個人情報の漏洩、滅失、毀損を防止するため、以下のセキュリティ対策を実施しています。

1. HTTPS通信の使用（本番環境）
2. セッションCookieのHTTPOnly属性設定
3. OAuth 2.0による安全な認証
4. アクセストークンの非永続化（セッション限定）
5. 定期的なセキュリティアップデート

## 第9条（個人情報の開示・訂正・削除）

ユーザーは、本サービスが保有する自己の個人情報について、以下の権利を有します。

1. 開示請求: 本サービスが保有する個人情報の開示を請求できます。
2. 訂正請求: 個人情報の内容が事実でない場合、訂正を請求できます。
3. 削除請求: 個人情報の削除を請求できます。

請求方法については、本ポリシー末尾の連絡先までお問い合わせください。

## 第10条（未成年者の個人情報）

本サービスは、13歳未満のユーザーからの個人情報を意図的に収集することはありません。保護者の方で、お子様が個人情報を提供したことに気づいた場合は、速やかにご連絡ください。

## 第11条（プライバシーポリシーの変更）

1. 本サービス運営者は、必要に応じて本ポリシーを変更することがあります。
2. 変更後のプライバシーポリシーは、本サービス上に掲示された時点で効力を生じるものとします。
3. 重要な変更がある場合は、本サービス上で目立つ形で告知します。

## 第12条（お問い合わせ窓口）

本ポリシーに関するお問い合わせは、以下の連絡先までお願いいたします。

- サービス名: ふくまど！
- 運営者: ふくまど！公式運営チーム
- メールアドレス: fukumado_admin@fukumado.jp
- お問い合わせフォーム: https://forms.gle/8epH3BGw8xDTGe1W6

## 第13条（準拠法・管轄裁判所）

本ポリシーの解釈にあたっては、日本法を準拠法とし、本サービス運営者の所在地を管轄する裁判所を専属的合意管轄とします。

以上
  `.trim()
};

/**
 * GET /api/legal/terms
 * 利用規約を取得
 */
legalRouter.get('/terms', (req: Request, res: Response) => {
  try {
    res.json({
      ...TERMS_OF_SERVICE,
      type: 'terms'
    });
  } catch (error) {
    console.error('[Legal API] Error fetching terms:', error);
    res.status(500).json({
      error: 'Failed to fetch terms of service'
    });
  }
});

/**
 * GET /api/legal/privacy
 * プライバシーポリシーを取得
 */
legalRouter.get('/privacy', (req: Request, res: Response) => {
  try {
    res.json({
      ...PRIVACY_POLICY,
      type: 'privacy'
    });
  } catch (error) {
    console.error('[Legal API] Error fetching privacy policy:', error);
    res.status(500).json({
      error: 'Failed to fetch privacy policy'
    });
  }
});

/**
 * GET /api/legal/versions
 * 文書バージョン情報を取得
 */
legalRouter.get('/versions', (req: Request, res: Response) => {
  try {
    res.json({
      terms: {
        version: TERMS_OF_SERVICE.version,
        effectiveDate: TERMS_OF_SERVICE.effectiveDate,
        lastUpdated: TERMS_OF_SERVICE.lastUpdated
      },
      privacy: {
        version: PRIVACY_POLICY.version,
        effectiveDate: PRIVACY_POLICY.effectiveDate,
        lastUpdated: PRIVACY_POLICY.lastUpdated
      }
    });
  } catch (error) {
    console.error('[Legal API] Error fetching versions:', error);
    res.status(500).json({
      error: 'Failed to fetch document versions'
    });
  }
});

/**
 * GET /api/legal/all
 * すべての法的文書を一度に取得（初回アクセス時用）
 */
legalRouter.get('/all', (req: Request, res: Response) => {
  try {
    res.json({
      terms: TERMS_OF_SERVICE,
      privacy: PRIVACY_POLICY
    });
  } catch (error) {
    console.error('[Legal API] Error fetching all documents:', error);
    res.status(500).json({
      error: 'Failed to fetch legal documents'
    });
  }
});
