generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                    String            @id @default(uuid()) @db.Uuid
  youtubeUserId         String?           @unique @map("youtube_user_id") @db.VarChar(255)
  twitchUserId          String?           @unique @map("twitch_user_id") @db.VarChar(255)
  displayName           String            @map("display_name") @db.VarChar(255)
  email                 String?           @db.VarChar(255)
  avatarUrl             String?           @map("avatar_url")
  youtubeAccessToken    String?           @map("youtube_access_token")
  youtubeRefreshToken   String?           @map("youtube_refresh_token")
  youtubeTokenExpiresAt DateTime?         @map("youtube_token_expires_at") @db.Timestamptz(6)
  twitchAccessToken     String?           @map("twitch_access_token")
  twitchRefreshToken    String?           @map("twitch_refresh_token")
  twitchTokenExpiresAt  DateTime?         @map("twitch_token_expires_at") @db.Timestamptz(6)
  createdAt             DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt             DateTime          @updatedAt @map("updated_at") @db.Timestamptz(6)
  lastLoginAt           DateTime?         @map("last_login_at") @db.Timestamptz(6)
  analyticsEvents       AnalyticsEvent[]
  followedChannels      FollowedChannel[]
  pageViews             PageView[]
  securityLogs          SecurityLog[]
  sessions              Session[]
  userPreferences       UserPreference?

  @@map("users")
}

model Channel {
  id                 BigInt   @id @default(autoincrement())
  platform           String   @db.VarChar(20)
  channelId          String   @map("channel_id") @db.VarChar(255)
  displayName        String   @map("display_name") @db.VarChar(255)
  username           String?  @db.VarChar(255)
  description        String?
  avatarUrl          String?  @map("avatar_url")
  bannerUrl          String?  @map("banner_url")
  subscriberCount    Int      @default(0) @map("subscriber_count")
  followerCount      Int      @default(0) @map("follower_count")
  viewCount          BigInt   @default(0) @map("view_count")
  videoCount         Int      @default(0) @map("video_count")
  isLive             Boolean  @default(false) @map("is_live")
  currentStreamId    String?  @map("current_stream_id") @db.VarChar(255)
  currentStreamTitle String?  @map("current_stream_title")
  currentViewerCount Int?     @map("current_viewer_count")
  createdAt          DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  lastSyncedAt       DateTime @default(now()) @map("last_synced_at") @db.Timestamptz(6)
  lastAccessedAt     DateTime @default(now()) @map("last_accessed_at") @db.Timestamptz(6)

  @@unique([platform, channelId])
  @@index([platform])
  @@index([platform, isLive, followerCount])
  @@index([platform, followerCount])
  @@index([platform, displayName])
  @@index([lastSyncedAt])
  @@index([lastAccessedAt])
  @@map("channels")
}

model FollowedChannel {
  id                  BigInt    @id @default(autoincrement())
  userId              String    @map("user_id") @db.Uuid
  platform            String    @db.VarChar(20)
  channelId           String    @map("channel_id") @db.VarChar(255)
  followedAt          DateTime  @default(now()) @map("followed_at") @db.Timestamptz(6)
  lastNotifiedAt      DateTime? @map("last_notified_at") @db.Timestamptz(6)
  notificationEnabled Boolean   @default(true) @map("notification_enabled")
  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, platform, channelId])
  @@index([userId])
  @@index([platform, channelId])
  @@index([userId, notificationEnabled])
  @@map("followed_channels")
}

model Emote {
  id           BigInt   @id @default(autoincrement())
  platform     String   @db.VarChar(20)
  emoteId      String   @map("emote_id") @db.VarChar(255)
  emoteCode    String   @map("emote_code") @db.VarChar(255)
  scope        String   @db.VarChar(20)
  channelId    String?  @map("channel_id") @db.VarChar(255)
  imageUrl1x   String   @map("image_url_1x")
  imageUrl2x   String?  @map("image_url_2x")
  imageUrl4x   String?  @map("image_url_4x")
  emoteType    String?  @map("emote_type") @db.VarChar(50)
  tier         String?  @db.VarChar(10)
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  lastSyncedAt DateTime @default(now()) @map("last_synced_at") @db.Timestamptz(6)

  @@unique([platform, emoteId])
  @@index([platform, scope])
  @@index([platform, channelId, scope])
  @@index([emoteCode])
  @@index([lastSyncedAt])
  @@map("emotes")
}

model Badge {
  id           BigInt   @id @default(autoincrement())
  platform     String   @db.VarChar(20)
  badgeSetId   String   @map("badge_set_id") @db.VarChar(255)
  badgeVersion String   @map("badge_version") @db.VarChar(50)
  scope        String   @db.VarChar(20)
  channelId    String?  @map("channel_id") @db.VarChar(255)
  imageUrl1x   String   @map("image_url_1x")
  imageUrl2x   String?  @map("image_url_2x")
  imageUrl4x   String?  @map("image_url_4x")
  title        String?  @db.VarChar(255)
  description  String?
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  lastSyncedAt DateTime @default(now()) @map("last_synced_at") @db.Timestamptz(6)

  @@index([platform, scope])
  @@index([platform, channelId])
  @@map("badges")
}

model PageView {
  id         BigInt   @id @default(autoincrement())
  ipHash     String   @map("ip_hash") @db.VarChar(64)
  path       String   @db.VarChar(255)
  referrer   String?
  userAgent  String?  @map("user_agent")
  userId     String?  @map("user_id") @db.Uuid
  deviceType String?  @map("device_type") @db.VarChar(20)
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  user       User?    @relation(fields: [userId], references: [id])

  @@index([createdAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
  @@index([ipHash, createdAt])
  @@map("page_views")
}

model AnalyticsEvent {
  id           BigInt   @id @default(autoincrement())
  eventType    String   @map("event_type") @db.VarChar(50)
  eventData    Json     @map("event_data")
  userId       String?  @map("user_id") @db.Uuid
  sessionId    String?  @map("session_id") @db.VarChar(255)
  ipHash       String   @map("ip_hash") @db.VarChar(64)
  userAgent    String?  @map("user_agent")
  deviceType   String?  @map("device_type") @db.VarChar(20)
  screenWidth  Int?     @map("screen_width")
  screenHeight Int?     @map("screen_height")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  user         User?    @relation(fields: [userId], references: [id])

  @@index([eventType, createdAt(sort: Desc)])
  @@index([createdAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
  @@index([sessionId, createdAt(sort: Desc)])
  @@map("analytics_events")
}

model SecurityLog {
  id         BigInt   @id @default(autoincrement())
  logType    String   @map("log_type") @db.VarChar(50)
  severity   String   @db.VarChar(20)
  ip         String   @db.VarChar(45)
  ipHash     String   @map("ip_hash") @db.VarChar(64)
  endpoint   String?  @db.VarChar(255)
  method     String?  @db.VarChar(10)
  statusCode Int?     @map("status_code")
  userAgent  String?  @map("user_agent")
  message    String?
  metadata   Json?
  userId     String?  @map("user_id") @db.Uuid
  username   String?  @db.VarChar(255)
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  user       User?    @relation(fields: [userId], references: [id])

  @@index([ipHash, createdAt(sort: Desc)])
  @@index([logType, createdAt(sort: Desc)])
  @@index([severity, createdAt(sort: Desc)])
  @@index([createdAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
  @@map("security_logs")
}

model IPWhitelist {
  id        BigInt   @id @default(autoincrement())
  ip        String   @unique @db.VarChar(45)
  reason    String?
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([ip])
  @@map("ip_whitelist")
}

model UserPreference {
  userId               String   @id @map("user_id") @db.Uuid
  defaultLayout        String   @default("grid_2x2") @map("default_layout") @db.VarChar(20)
  savedLayouts         Json     @default("[]") @map("saved_layouts")
  notificationSettings Json     @default("{\"sound\": true, \"enabled\": true}") @map("notification_settings")
  preferences          Json     @default("{}") @db.Json
  createdAt            DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}

model Session {
  sid        String   @id @db.VarChar(255)
  sess       Json
  expire     DateTime @db.Timestamptz(6)
  user_id    String?  @db.Uuid
  created_at DateTime @default(now()) @db.Timestamptz(6)
  users      User?    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([expire])
  @@index([user_id])
  @@map("sessions")
}

model AuditLog {
  id           BigInt   @id @default(autoincrement())
  action       String   @db.VarChar(100)
  actor        String   @db.VarChar(255)
  actorIp      String   @map("actor_ip") @db.VarChar(45)
  actorAgent   String?  @map("actor_agent")
  targetType   String   @map("target_type") @db.VarChar(50)
  targetId     String?  @map("target_id") @db.VarChar(255)
  details      Json?
  status       String   @db.VarChar(20)
  errorMessage String?  @map("error_message")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([action, createdAt(sort: Desc)], map: "idx_audit_logs_action_created_at")
  @@index([actor, createdAt(sort: Desc)], map: "idx_audit_logs_actor_created_at")
  @@index([actorIp, createdAt(sort: Desc)], map: "idx_audit_logs_actor_ip_created_at")
  @@index([createdAt(sort: Desc)], map: "idx_audit_logs_created_at")
  @@index([status, createdAt(sort: Desc)], map: "idx_audit_logs_status_created_at")
  @@index([targetType, createdAt(sort: Desc)], map: "idx_audit_logs_target_type_created_at")
  @@map("audit_logs")
}

model Alert {
  id             BigInt    @id @default(autoincrement())
  type           String    @db.VarChar(50)
  severity       String    @db.VarChar(20)
  title          String    @db.VarChar(255)
  message        String
  details        Json?
  acknowledged   Boolean   @default(false)
  acknowledgedAt DateTime? @map("acknowledged_at") @db.Timestamptz(6)
  acknowledgedBy String?   @map("acknowledged_by") @db.VarChar(255)
  resolved       Boolean   @default(false)
  resolvedAt     DateTime? @map("resolved_at") @db.Timestamptz(6)
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([type, createdAt(sort: Desc)])
  @@index([severity, createdAt(sort: Desc)])
  @@index([acknowledged, createdAt(sort: Desc)])
  @@index([resolved, createdAt(sort: Desc)])
  @@index([createdAt(sort: Desc)])
  @@map("alerts")
}

model AlertSetting {
  id            Int      @id @default(autoincrement())
  type          String   @unique @db.VarChar(50)
  enabled       Boolean  @default(true)
  threshold     Float?
  notifyEmail   Boolean  @default(false) @map("notify_email")
  notifySlack   Boolean  @default(false) @map("notify_slack")
  notifyWebhook Boolean  @default(false) @map("notify_webhook")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@map("alert_settings")
}

model HelpArticle {
  id          BigInt   @id @default(autoincrement())
  category    String   @db.VarChar(50)
  title       String   @db.VarChar(255)
  content     String   @db.Text
  order       Int      @default(0)
  isPublished Boolean  @default(false) @map("is_published")
  viewCount   Int      @default(0) @map("view_count")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([category, order])
  @@index([isPublished, order])
  @@map("help_articles")
}

model Announcement {
  id                  BigInt    @id @default(autoincrement())
  type                String    @db.VarChar(20)
  title               String    @db.VarChar(255)
  content             String    @db.Text
  link                String?   @db.VarChar(500)
  linkText            String?   @map("link_text") @db.VarChar(100)
  priority            Int       @default(0)
  isActive            Boolean   @default(true) @map("is_active")
  forceDisplayVersion Int       @default(1) @map("force_display_version")
  startAt             DateTime? @map("start_at") @db.Timestamptz(6)
  endAt               DateTime? @map("end_at") @db.Timestamptz(6)
  createdAt           DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([isActive, priority(sort: Desc)])
  @@index([startAt, endAt])
  @@map("announcements")
}
