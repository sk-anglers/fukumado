# 12. 制限事項・既知の問題

このセクションでは、ふくまど！の技術的制限と既知の問題について説明します。

## 12.1 iframe クロスオリジン制限

### 配信ストリーミングデータの測定不可
- **問題**: Resource Timing APIは、iframe内のリソースを測定できない
- **影響**: データ使用量監視で配信動画のデータ転送量が含まれない
- **測定可能**: JS/CSS/画像/APIリクエストなど、メインページのリソースのみ
- **表示**: AccountMenuに注意書き表示

**技術的詳細**:
```typescript
// iframe内のリソースは transferSize が 0 になる
const resources = performance.getEntriesByType('resource');
// クロスオリジン制限により、配信動画の転送量は取得不可
```

### 音声レベル監視の制限
- **問題**: Web Audio APIは、クロスオリジンiframe内のaudio要素にアクセスできない
- **影響**: useAudioLevelMonitorが実際の音声を分析できない
- **現状**: ランダムな音量レベルをシミュレーション（デモ用）
- **将来の改善案**:
  - バックエンドで音声分析
  - プラットフォームAPIで音量情報取得

## 12.2 プラットフォーム別制限

### YouTube
- **埋め込み無効配信**: 一部の配信は埋め込みが許可されていない
- **年齢制限**: 年齢制限付き配信は認証が必要
- **API クォータ**: 1日10,000 units（search: 100 units）
- **回避策**: キャッシング、fallbackクエリの最小化

### Twitch
- **音量制御の遅延**: Twitch Embed APIの音量変更に若干のラグがある
- **API レート制限**: 800リクエスト/分
- **回避策**: バッチ処理、キャッシング

### ニコニコ生放送
- **プレイヤー制御不可**: 外部APIがないため、音量・画質の制御ができない
- **機能未実装**: ニコニコAPIの実装が不完全（推定）
- **チャット機能**: 現状未対応

## 12.3 音声同期機能

### マスタースロット機能の実装状態
- **UI**: 同期ボタン、プレビュー状態の表示は実装済み
- **実際の同期**: 音声タイミングの同期ロジックは未実装または未確認
- **プレビュー状態**: 視覚的な表示のみで、実際のプレイヤー制御は不明

**今後の実装案**:
1. Web Audio API で音声遅延を測定
2. マスタースロットとの時間差を計算
3. 他のスロットの再生位置を調整

## 12.4 パフォーマンス

### 多数配信同時視聴時の負荷
- **CPU使用率**: 複数のiframeプレイヤーを同時再生すると高負荷
- **メモリ使用量**: 配信数に比例して増加
- **推奨**: 4スロット以下での使用

**パフォーマンス指標**:
| スロット数 | CPU使用率 | メモリ使用量 | 推奨環境 |
|---|---|---|---|
| 1-2 | 低 (~20%) | 低 (~500MB) | すべての環境 |
| 3-4 | 中 (~40%) | 中 (~1GB) | 標準的なPC |
| 5-8 | 高 (~70%) | 高 (~2GB) | 高性能PC |

## 12.5 モバイル対応

### 改善済み（v0.1.1）
- ✅ **ChatPanel**: 閉じるボタン追加（モバイルのみ表示）
- ✅ **Sidebar**: 閉じるボタン追加（モバイルのみ表示）
- ✅ **EmotePicker**: 画面サイズに応じた動的配置・サイズ調整
- ✅ **StreamSlot**: 小さな×ボタン追加、タッチ対応

### 残存課題
- ⚠️ **レスポンシブデザイン**: デスクトップ向けレイアウトが基本
- ⚠️ **表示崩れ**: 小画面での一部UI要素の配置問題
- ⚠️ **パフォーマンス**: モバイル環境での複数配信同時視聴
- 📝 **今後の課題**: 完全なレスポンシブ対応の実装

## 12.6 パフォーマンス・フリーズ問題

### スロット削除時のフリーズ（部分的に解決）

**問題**:
- 配信スロット削除時にブラウザがフリーズする現象
- 特に一番下のスロットで頻度が高い
- 症状: 削除後に音が消える → 数秒後にフリーズ

**根本原因**:
1. **不必要な再レンダリング**:
   - layoutStore の `map()` パターンが全スロットの新しいオブジェクトを生成
   - React.memo が機能せず、全スロットが再レンダリング
   - useEffect が全スロットで実行され、プレイヤーの初期化/破棄が走る

2. **プレイヤー破棄の不完全性**:
   - Twitchプレイヤーの `destroy()` が完全に停止しない
   - バックグラウンドプロセス（WebWorker等）が残り続ける
   - コンソールに "jumping gap" ログが出続ける

**実施した対策**:
1. ✅ **layoutStore の最適化**:
   - `map()` → `slice()` + 個別インデックス更新パターンに変更
   - 変更されたスロットのみ新しいオブジェクト参照を持つ
   - 影響: assignStream, clearSlot, toggleSlotMute, setVolume, setSlotQuality

2. ✅ **StreamGrid の最適化**:
   - `useStoreWithEqualityFn` + shallow 比較でストア購読
   - `activeSlots` を `useMemo` でメモ化
   - インライン関数を排除（props として selectedSlotId, preset を渡す）

3. ✅ **StreamSlot の最適化**:
   - コンポーネント全体を `React.memo` でメモ化
   - `useStoreWithEqualityFn` + shallow 比較
   - isActive, isFocused を計算プロパティ化

4. ✅ **プレイヤークリーンアップの強化**:
   - DOMコンテナを先にクリア (`innerHTML = ''`)
   - Twitchプレイヤー: setMuted(true) → setVolume(0) → pause() → destroy()
   - setTimeout削除、destroy()を即座に実行
   - 詳細なデバッグログ出力

**現状**:
- ✅ 一番上のスロット削除: 問題解消
- ❌ 一番下のスロット削除: **フリーズが残存**
- コンソールログによると、destroy()は正常に完了しているが、その後もTwitchプレイヤーのログが出続ける

**今後の調査・対策**:
- すべてのスロットを削除してもログが出続けるか確認
- Twitchプレイヤーのより強力な破棄方法を調査
- バックエンドでのプレイヤー管理の検討
- iframe自体を完全に削除する方法の検討

## 12.7 認証・セキュリティ

**注**: セキュリティの詳細な仕様については、[15. セキュリティ仕様](./15_security.md) を参照してください。

このセクションでは、既知の問題と改善が必要な点のみを記載します。

### OAuth 2.0 セキュリティ

#### CSRF対策（State パラメータ）
- ✅ **実装済み**: `state`パラメータによるCSRF攻撃対策
- ✅ Google OAuth: `req.session.oauthState`で検証
- ✅ Twitch OAuth: `req.session.twitchOauthState`で検証
- ✅ コールバック時に`state`不一致の場合はエラー

**実装箇所**: `server/src/routes/auth.ts`

#### 認証完了画面のセキュリティ
- ✅ **ポップアップウィンドウ判定**: `window.opener`による安全な判定
- ✅ **自動クローズ**: 3秒後に自動的にウィンドウを閉じる
- ⚠️ **window.openerリスク**: タブナビゲーションのリスクあり（将来的に`rel="noopener"`推奨）
- ⚠️ **CSP未設定**: Content Security Policyの設定が必要

**推奨改善**:
```typescript
// OAuth認証ウィンドウを開く際
window.open(authUrl, '_blank', 'noopener,noreferrer');

// CSP設定
app.use((req, res, next) => {
  res.setHeader("Content-Security-Policy",
    "default-src 'self'; script-src 'self' 'unsafe-inline';");
  next();
});
```

### セッション管理
- ✅ **Cookie使用**: バックエンドでセッションCookieを使用
- ✅ **httpOnly**: XSS対策として`httpOnly: true`を設定
- ✅ **sameSite**: CSRF対策として`sameSite: 'lax'`を設定
- ⚠️ **secure**: 開発環境では`false`、本番環境では`true`必須
- ⚠️ **セッションタイムアウト**: 未設定（要実装）

**現在の設定**: `server/src/index.ts`
```typescript
session({
  secret: process.env.SESSION_SECRET || 'your-secret-key',
  resave: false,
  saveUninitialized: false,
  cookie: {
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production',
    sameSite: 'lax'
  }
})
```

**推奨改善**:
```typescript
// セッションタイムアウト設定
session({
  cookie: {
    maxAge: 24 * 60 * 60 * 1000 // 24時間
  }
})

// セッションストアをRedisに移行（本番環境）
import RedisStore from 'connect-redis';
session({
  store: new RedisStore({ client: redisClient }),
  // ...
})
```

### OAuth トークン管理
- ✅ **リフレッシュトークン**: 実装済み
  - `ensureGoogleAccessToken()`: Google トークン自動リフレッシュ
  - `ensureTwitchAccessToken()`: Twitch トークン自動リフレッシュ
  - 期限切れ30秒前に自動更新
- ✅ **トークン保存**: サーバーサイドセッションに保存（フロントエンドに非公開）
- ✅ **TokenStorage**: sessionID → トークンのマッピング（WebSocket用）

**実装箇所**: `server/src/routes/auth.ts`

### セキュリティ監査チェックリスト

**詳細**: [15. セキュリティ仕様 - 15.8 セキュリティ監査チェックリスト](./15_security.md#158-セキュリティ監査チェックリスト) を参照

#### 実装済み
- ✅ OAuth 2.0 CSRF対策（state パラメータ）
- ✅ セッションCookie（httpOnly, sameSite）
- ✅ アクセストークンのサーバーサイド管理
- ✅ トークン自動リフレッシュ
- ✅ Webhook署名検証（Twitch EventSub）
- ✅ セキュリティヘッダー（Helmet、CSP、HSTS）
- ✅ レート制限（API、認証、WebSocket）
- ✅ DDoS対策（IPブロックリスト、リクエストサイズ制限）
- ✅ セッションセキュリティ（ハイジャック検出、タイムアウト、CSRF保護）
- ✅ 異常検知・監視（トラフィック急増、エラー急増、不審なアクティビティ）

#### 要改善
- ⚠️ 本番環境でのHTTPS設定（secure: true）
- ⚠️ 本番環境でのRedis Session Store導入
- ⚠️ `rel="noopener"`使用（認証ポップアップ）
- ⚠️ HTTPS強制リダイレクト（本番環境）
- ⚠️ ログの永続化（ログファイルまたはログ管理サービス）
- ⚠️ アラート通知機能（Slack、Email等）

## 12.8 エラーハンドリング

### ネットワークエラー時の復旧
- ⚠️ **配信リスト取得失敗**: エラーメッセージ表示のみ、自動リトライなし
- ⚠️ **WebSocket切断**: 再接続ロジックの有無は未確認
- ⚠️ **APIタイムアウト**: タイムアウト設定の有無は未確認

**推奨改善**:
- エクスポネンシャルバックオフによる自動リトライ
- WebSocket自動再接続（最大5回）
- ユーザーへの明確なエラー通知

## 12.9 ブラウザ互換性

### サポート状況
| ブラウザ | バージョン | サポート状況 |
|---|---|---|
| Chrome | 最新 | ✅ 完全サポート |
| Firefox | 最新 | ✅ 完全サポート |
| Safari | 最新 | ⚠️ 部分サポート |
| Edge | 最新 | ✅ 完全サポート |
| Mobile Safari | iOS 15+ | ⚠️ 制限あり |
| Chrome Mobile | Android 10+ | ✅ サポート |

### Safari での既知の問題
- WebSocket接続の不安定性
- Twitch Embed APIの一部機能制限
- autoplayポリシーの厳格化

## 12.10 アクセシビリティ

### 現状の対応状況
- ⚠️ キーボードナビゲーション: 一部未対応
- ⚠️ スクリーンリーダー: ARIA属性が不十分
- ⚠️ コントラスト比: 一部で不足
- ⚠️ フォーカス管理: モーダル内でのフォーカストラップ未実装

**改善推奨**:
- WAI-ARIA ランドマーク追加
- フォーカストラップの実装
- キーボードショートカットの追加
- コントラスト比の改善

## 12.11 既知のバグ

### 高優先度
1. **スロット削除時のフリーズ** (一部解決済み)
   - 優先度: 高
   - 影響: ユーザー体験

2. **WebSocket切断時の再接続** (未確認)
   - 優先度: 高
   - 影響: チャット機能

### 中優先度
1. **モバイル表示崩れ**
   - 優先度: 中
   - 影響: モバイルユーザー

2. **Safari での WebSocket 不安定性**
   - 優先度: 中
   - 影響: Safariユーザー

### 低優先度
1. **音声同期機能の未実装**
   - 優先度: 低
   - 影響: 一部のユースケース

2. **エモートキャッシングなし**
   - 優先度: 低
   - 影響: パフォーマンス（軽微）

## 12.12 制限事項の回避策

### データ使用量監視の制限
**回避策**: 画質を手動で下げることで、おおよそのデータ使用量を推定
- 1080p: ~6 Mbps
- 720p: ~3 Mbps
- 480p: ~1.5 Mbps

### 音声同期機能の代替
**回避策**: 手動で音量バランスを調整し、1つのスロットに注目する

### モバイル対応の代替
**回避策**: デスクトップ版の使用を推奨
